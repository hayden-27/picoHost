var PicoCadViewer=function(){"use strict";var t="undefined"!=typeof Float32Array?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var e=function(t,e,r,i,n){var o,a=1/Math.tan(e/2);return t[0]=a/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=n&&n!==1/0?(o=1/(i-n),t[10]=(n+i)*o,t[14]=2*n*i*o):(t[10]=-1,t[14]=-2*i),t};function r(){var e=new t(3);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}r();const i=[[0,0,0],[29,43,83],[126,37,83],[0,135,81],[171,82,54],[95,87,79],[194,195,199],[255,241,232],[255,0,77],[255,163,0],[255,236,39],[0,228,54],[41,173,255],[131,118,156],[255,119,168],[255,204,170]];class n{constructor(t,e={}){this.objects=t,this.name=e.name,this.backgroundIndex=e.backgroundIndex??0,this.alphaIndex=e.alphaIndex??0,this.zoomLevel=e.zoomLevel,this.texture=e.texture}backgroundColor(){return i[this.backgroundIndex]}alphaColor(){return i[this.alphaIndex]}textureAsImage(t){null==t&&(t=i);const e=new ImageData(128,128),r=e.data,n=this.texture,o=this.alphaIndex;let a=0,s=0;for(let e=0;e<120;e++)for(let e=0;e<128;e++){const e=n[a];if(e!==o){const i=t[e];r[s]=i[0],r[s+1]=i[1],r[s+2]=i[2],r[s+3]=255}a++,s+=4}return e}}class o{constructor(t,e,r,i,n){this.name=t,this.position=e,this.rotation=r,this.vertices=i,this.faces=n}}class a{constructor(t,e,r,i={}){this.indices=t,this.colorIndex=e,this.uvs=r,this.shading=i.shading??!0,this.texture=i.texture??!0,this.doubleSided=i.doubleSided??!1,this.renderFirst=i.renderFirst??!1}color(){return i[this.colorIndex]}}class s{constructor(t,e={}){this.gl=t,this.cull=e.cull??!0,this.shading=e.shading??!0,this.texture=e.texture??!0,this.clearDepth=e.clearDepth??!1,this.vertices=[],this.normals=[],this.uvs=[],this.colorUVs=[],this.triangles=[]}save(){const t=this.gl;this.vertexCount=this.triangles.length,this.isEmpty()||(this.vertexBuffer=t.createBuffer(),this.uvBuffer=t.createBuffer(),this.colorUVBuffer=t.createBuffer(),this.triangleBuffer=t.createBuffer(),this.normalBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.uvBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.uvs),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.colorUVBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.colorUVs),t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.triangleBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(this.triangles),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,this.normalBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.normals),t.STATIC_DRAW)),this.uvs=null,this.colorUVs=null,this.normals=null,this.vertices=null,this.triangles=null}isEmpty(){return 0===this.vertexCount}free(){const t=this.gl;t.deleteBuffer(this.vertexBuffer),t.deleteBuffer(this.uvBuffer),t.deleteBuffer(this.colorUVBuffer),t.deleteBuffer(this.triangleBuffer),t.deleteBuffer(this.normalBuffer)}}class l{constructor(t){this.gl=t,this.vertices=[]}save(){const t=this.gl;this.vertexCount=Math.floor(this.vertices.length/3),this.vertexBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array(this.vertices),t.STATIC_DRAW),this.vertices=null}free(){this.gl.deleteBuffer(this.vertexBuffer)}}function h(t,e,r){const{passes:i,wireframe:n}=function(t,e,r){const i=[];for(let e=0;e<16;e++){const r=e%2<1,n=e%4<2,o=e%8<4;i.push(new s(t,{cull:!r,shading:n,texture:o,clearDepth:8===e}))}const n=new l(t),o=n.vertices;for(const t of e.objects){const e=t.position,n=t.vertices.map((t=>[-t[0]-e[0],-t[1]-e[1],t[2]+e[2]]));for(const e of t.faces){const t=e.indices,a=e.uvs,s=i[(e.doubleSided?0:1)+(e.shading?0:2)+(e.texture?0:4)+(e.renderFirst?0:8)],l=s.vertices,h=s.triangles,c=s.normals,m=s.uvs,g=s.colorUVs,d=.03125+e.colorIndex/16,x=0,_=Math.floor(l.length/3),p=[],T=[];for(let e=0;e<t.length;e++){const r=n[t[e]],i=n[t[0===e?t.length-1:e-1]],s=a[e];p.push(r),o.push(r[0],r[1],r[2],i[0],i[1],i[2]),T.push([s[0]/16,s[1]/16])}const v=f(p);if(4===t.length&&e.texture&&r>1){const t=p[0],e=p[1],i=p[2],n=p[3],o=T[0],a=T[1],s=T[2],f=T[3];for(let h=0;h<=r;h++){const _=h/r,p=[u(t[0],e[0],_),u(t[1],e[1],_),u(t[2],e[2],_),u(o[0],a[0],_),u(o[1],a[1],_)],T=[u(n[0],i[0],_),u(n[1],i[1],_),u(n[2],i[2],_),u(f[0],s[0],_),u(f[1],s[1],_)];for(let t=0;t<=r;t++){const e=t/r;l.push(u(p[0],T[0],e),u(p[1],T[1],e),u(p[2],T[2],e)),m.push(u(p[3],T[3],e),u(p[4],T[4],e)),g.push(d,x),c.push(v[0],v[1],v[2])}}for(let t=0;t<r;t++)for(let e=0;e<r;e++){const i=e*(r+1),n=_+i+t+1,o=_+i+t+r+1;h.push(_+i+t,n,o,o,n,_+i+t+r+2)}}else{for(const t of p)l.push(t[0],t[1],t[2]),c.push(v[0],v[1],v[2]);for(let t=0;t<T.length;t++)if(g.push(d,x),e.texture){const e=T[t];m.push(e[0],e[1])}else m.push(d,x);for(let e=0,r=t.length-2;e<r;e++)h.push(_+1+e,_,_+2+e)}}}for(const t of i)t.save();return n.save(),{passes:i,wireframe:n}}(t,e,r+1);return{passes:i,wireframe:n,textureIndices:function(t,e){const r=Array(16384).fill(255);for(let i=0;i<t.length;i++){const n=t[i];r[i]=n===e?255:n}for(let t=0;t<16;t++)r[16256+t]=t;return r}(e.texture,e.alphaIndex)}}function u(t,e,r){return t+(e-t)*r}function f(t){for(let i=0;i<t.length;i++){const n=t[i],o=t[(i+1)%t.length],a=t[(i+2)%t.length],s=[n[0]-o[0],n[1]-o[1],n[2]-o[2]],l=[o[0]-a[0],o[1]-a[1],o[2]-a[2]],h=(r=s,[(e=l)[1]*r[2]-e[2]*r[1],e[2]*r[0]-e[0]*r[2],e[0]*r[1]-e[1]*r[0]]),u=c(h);if(u>0)return[h[0]/u,h[1]/u,h[2]/u]}var e,r;return[1,0,0]}function c(t){return Math.hypot(t[0],t[1],t[2])}class m{constructor(t,e,r){this.gl=t;const i=this.createShader(t.VERTEX_SHADER,e),n=this.createShader(t.FRAGMENT_SHADER,r);if(this.program=t.createProgram(),t.attachShader(this.program,i),t.attachShader(this.program,n),t.linkProgram(this.program),t.deleteShader(i),t.deleteShader(n),!t.getProgramParameter(this.program,t.LINK_STATUS)){const e=t.getProgramInfoLog(this.program);throw t.deleteProgram(this.program),Error("program compilation failed: "+e)}this.vertexLocation=this.getAttribLocation("vertex")}createShader(t,e){const r=this.gl,i=r.createShader(t);if(r.shaderSource(i,e),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS)){const e=r.getShaderInfoLog(i);throw r.deleteShader(i),Error(`${t===r.FRAGMENT_SHADER?"fragment":"vertex"} shader compilation failed: ${e}`)}return i}getAttribLocation(t){return this.gl.getAttribLocation(this.program,t)}getUniformLocation(t){return this.gl.getUniformLocation(this.program,t)}use(){this.gl.useProgram(this.program)}free(){this.gl.deleteProgram(this.program)}}function g(){return function(t,e,r){const n=new ImageData(t,e),o=n.data,a=t*e;let s=0;for(let t=0;t<a;t++){const e=i[parseInt(r.charAt(t),16)];o[s]=e[0],o[s+1]=e[1],o[s+2]=e[2],o[s+3]=255,s+=4}return n}(32,4,"00112233445566778899aabbccddeeff0010213542516d768294a9b3cdd5e8fe000011552211dd6622449933dd55889900000011110055dd1122445555112244")}function d(t){return function(t){let e=0;return i();function r(){const r=t.charAt(e);if("{"===r)return i();if("'"===r)return n();if("-"===r||"."===r||r>="0"&&r<="9")return o();throw Error("Unkown value ("+e+'): "'+r+'" = '+r.charCodeAt(0))}function i(){e++;const i={array:[],dict:Object.create(null)};for(a();;){const n=t.charAt(e);if("}"===n){e++;break}let o;if(n>="a"&&n<="z"){let r=e;for(e++;;){if("="===t.charAt(e))break;e++}o=t.slice(r,e),e++}const s=r();null==o?i.array.push(s):i.dict[o]=s,a();","===t.charAt(e)&&(e++,a())}return i}function n(){const r=e,i=t.indexOf("'",e+1);if(i<0)throw Error("No end!!!");if(e=i+1,e===r)throw Error("!!!!");return t.slice(r+1,i)}function o(){const r=e;for(;;){const r=t.charAt(e);if(!("-"===r||"."===r||r>="0"&&r<="9"))break;e++}if(e===r)throw Error("!!!!");return Number(t.slice(r,e))}function a(){for(;;){const r=t.charAt(e);if(" "!==r&&"\n"!==r&&"\r"!==r&&"\t"!==r)break;e++}}}(t)}function x(t){let e=0,r=t.length;for(;e<t.length;){const i=t.charAt(e);if(e++,"\n"===i){r=e-1;break}if("\r"===i){r=e-1,"\n"===t.charAt(e)&&e++;break}}return[t.slice(0,r),t.slice(e)]}function _(t){if(!t.startsWith("picocad;"))throw Error("Not a picoCAD file.");const[e,r]=x(t),i=e.split(";"),s=i[1],[l,h,u]=i.slice(2).map((t=>Number(t))),[f,c]=function(t,e){const r=t.indexOf(e);return r<0?[t,""]:[t.slice(0,r),t.slice(r+e.length)]}(r,"%"),m=d(f),g=m.array.map((t=>{const e=t.dict.name,r=t.dict.pos.array,i=t.dict.rot.array,n=t.dict.v.array.map((t=>t.array)),s=t.dict.f.array.map((t=>{const e=t.array.map((t=>t-1)),r=t.dict.c,i=t.dict.uv.array,n=[];for(let t=1;t<i.length;t+=2)n.push([i[t-1],i[t]]);return new a(e,r,n,{shading:1!==t.dict.noshade,texture:1!==t.dict.notex,doubleSided:1===t.dict.dbl,renderFirst:1===t.dict.prio})}));return new o(e,r,i,n,s)}));const _=function(t){const e=Array(15360);let r,i=0;for(let n=0;n<120;n++){[r,t]=x(t);for(let t=0;t<128;t++)e[i]=Number.parseInt(r.charAt(t),16),i++}return e}(x(c)[1]);return new n(g,{name:s,alphaIndex:u,backgroundIndex:h,zoomLevel:l,texture:_})}function p(t){return(t.length<4?4278190080:function(t,e){for(let r=0;r<e;r++)t*=2;return t}(t[3],24))+(t[2]<<16)+(t[1]<<8)+t[0]}function T(t){return t.map((t=>Math.floor(255.999*t)))}function v(t,e,r){return.2126*t+.7152*e+.0722*r}const A="R0lGODdhgACAAIAAAAAAAP///yH5BAkKAAAALAAAAACAAIAAAAL/hI+py+0Po5y02ouz3rz7D4biSJbmiabqyrbuC5vBHBtBcitz/ty859PpaIgdjngIFgE/pvMIxTWaRpAy+UwibVtnM9sDM7tVLOP7FQOHVDJZfLWp3cLzMV2PYsow6oQvJ4GGV1NoeIiYqLgYJoUGBhg3tpBWKUQogrnkeIfUZaaVt0kpCmr1h9pWyhVB2Pba+mkXsuP5dtk6tarGS6E5CiH5CJu7KjkruMu4zNzs/BwTOUiMRR14h10k61ucXa1sueSnDFf+uDsNzinlHaptPRauBc9dr70OfI1OKs7/bewvXzxy7Qa+K6jP4LyACgUydKgOmsSJFCtaRHXx2TE6/0P0LDzo0UvBSOXYhGTVL6U7h8IG7TvH7l5MkP9qJuTiZxy+m7xawhQojFTOnShtNiyKdCVPkvA+bRyqMmnGqVSrWr3KzOmZnz24TupIUw5Uo0GbIpspMpg5oniGsZ1jslTbsxWkgQXI1o3XhPLQmqq7Ne/Dr0DfqBo59ySlbVgbO34M+aE0lzLDHiUsFvHYpRwVb077NzPLwRsllxy5Nljn0KClao07+qSlz8eEvsUV++1et6Np98pL+aNwzrRXix7eOjnjyMybO6cIaI5Ts76rI3xd+ULZ2wCtR01+sy9ruKgPW4brvbBXWZWo+8V8HChu5EwZJn6/l/zd+PA5G/8zrNl+4f3yXIEGHghNLUYEwSA7Cl6jU1g0bDFZOw/GUwtNF5qiIBENYrggD56AkiFOWWw44Q98XFjFhAOpWJktInYoUoMLEuYiXxSWCKKJLZbYoQ8zgkjhPULi5CGNNYrlYogimsFjj8OlKGFaP5a04pAmInnjhygCyRo96UQl5Iw/sqjXLQiuyWab0UQJB48b+gIkjTZuCaFn2eTw5BR8yuiNk8qRyKArS/I1SpRwvtLkkrYQCeNKHormZYplZngnhhza10mfmiT5Z5Za9hepF4XqcmeOSvTF53Gt/jbPiBDKCacgdT6Y6aQ8NXSkO08S6Gawwg7rQK2QEIrdrlj/dhLaorSStMmIigp4qShyLnZmdGYShOieyZrZZ0zAliqXPkr+idxM65mbh3l5LuWPihHKpwunEGmqnKFQMqsUns1O56m8weXjbLTLEYtwwm6+Wg2j+xYlr1polsFeng6TySsboFocSJmEdmWwjJFue+KKGg95BcWrvvtqy4mixXC4fymJ3qrQenqiI0du7LKp4f76xMj4Dv3VqOi+e+xiscqk66Mdw0dx0bbd+KJc2ppltcJab621TuCSy2XD5wHLwZxJMSoziR5RGaOuHTMs8T71zrxop75GayTeSPM6ZthICtgatKfJHXSSe/eaWqPqchxxRPaO3Z7BesD999H0/Yptmb5rG8t15543N++/Rdr9MKnTihurwP2orl62X+vtd6Jm95Q67GkP9Utb48z7865Co8QV5U/nKKW4igKoduxh0hUetXNn18u6OSetZm7K6xiFNdOhs9vn3n8PeiyC40XcjvYdX30ddZPur+zRUb90vOYam7sdYBev7Hz9sjt9vWDzpjzhCWx373kepmBWusEMb3AGFEfa4MW+SfCueiTb39SsJaoraexe4OugByWSwXeMDkb3K96XVNYM8cyChLnpndw+NB5sbWCAIvxdfFxIu/j5hYbQQwrNiqVAVlmJf/rZYXccV5dnDWxTOEpT4zbnLtHR44NUrGJGCgAAOw==";let b=!1,E=null;function R(){return b||(b=!0,async function(){return new Promise(((t,e)=>{let r=new Image;r.onload=()=>t(r),r.onerror=()=>e("could not load PICO-8 font"),r.src="data:image/gif;base64,"+A}))}().then((t=>E=t))),E}return class{constructor(t={}){this.canvas=t.canvas,null==this.canvas&&(this.canvas=document.createElement("canvas"));const e=this.gl=this.canvas.getContext("webgl",{antialias:!1,preserveDrawingBuffer:t.preserveDrawingBuffer??!1});e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),this.cameraPosition={x:0,y:0,z:0},this.cameraRotation={x:0,y:0,z:0},this.cameraFOV=t.fov??90,this.loaded=!1,this.model=null,this.shading=t.shading??!0,this.renderMode=t.renderMode??"texture",this.backgroundColor=null,this.outlineColor=[0,0,0,1],this.outlineSize=0,this._watermarkText=null,this._watermarkSize=null,this._watermarkBuffer=null,this._watermarkTriangleCount=0,this.drawWireframe=t.drawWireframe??!1,this.wireframeXray=t.wireframeXray??!0,this.wireframeColor=t.wireframeColor??[1,1,1],this.tesselationCount=t.tesselationCount??3,this.lightDirection=t.lightDirection??{x:1,y:-1,z:0},this.hdOptions={shadingSteps:4,shadingColor:[.1,.1,.1]},this._passes=[],this._colorIndexTex=this._createTexture(null,this.gl.LUMINANCE,this.gl.LUMINANCE,this.gl.UNSIGNED_BYTE,new Uint8Array([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]),16,1),this._indexTex=null,this._fontTex=null,this.resetLightMap(),this._programTexture=function(t){const e=new m(t,"\n\t\tattribute vec4 vertex;\n\t\tattribute vec3 normal;\n\t\tattribute vec2 uv;\n\n\t\tvarying highp vec2 v_uv;\n\t\tvarying highp vec3 v_normal;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tv_normal = normal;\n\t\t\tv_uv = uv;\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\tvarying highp vec3 v_normal;\n\t\t\n\t\tuniform sampler2D indexTex;\n\t\tuniform sampler2D lightMap;\n\t\tuniform highp vec3 lightDir;\n\t\tuniform highp float lightMapOffset;\n\t\tuniform highp float lightMapGradient;\n\n\t\tvoid main() {\n\t\t\thighp float index = texture2D(indexTex, v_uv).r;\n\t\t\tif (index == 1.0) discard;\n\t\t\thighp float intensity = clamp(lightMapGradient * abs(dot(v_normal, lightDir)) + lightMapOffset, 0.0, 1.0);\n\t\t\tgl_FragColor = texture2D(lightMap, vec2(0.015625 + index * 15.9375 + mod(gl_FragCoord.x + gl_FragCoord.y, 2.0) * 0.03125, 1.0 - intensity));\n\t\t}\n\t");return{program:e,locations:{uv:e.getAttribLocation("uv"),normal:e.getAttribLocation("normal"),indexTex:e.getUniformLocation("indexTex"),lightMap:e.getUniformLocation("lightMap"),lightDir:e.getUniformLocation("lightDir"),mvp:e.getUniformLocation("mvp"),lightMapOffset:e.getUniformLocation("lightMapOffset"),lightMapGradient:e.getUniformLocation("lightMapGradient")}}}(e),this._programUnlitTexture=function(t){const e=new m(t,"\n\t\tattribute vec4 vertex;\n\t\tattribute vec2 uv;\n\n\t\tvarying highp vec2 v_uv;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tv_uv = uv;\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\t\n\t\tuniform sampler2D indexTex;\n\t\tuniform sampler2D lightMap;\n\n\t\tvoid main() {\n\t\t\thighp float index = texture2D(indexTex, v_uv).r;\n\t\t\tif (index == 1.0) discard;\n\t\t\tgl_FragColor = texture2D(lightMap, vec2(0.015625 + index * 15.9375, 0.0));\n\t\t}\n\t");return{program:e,locations:{uv:e.getAttribLocation("uv"),mvp:e.getUniformLocation("mvp"),indexTex:e.getUniformLocation("indexTex"),lightMap:e.getUniformLocation("lightMap")}}}(e),this._programHDTexture=function(t){const e=new m(t,"\n\t\tattribute vec4 vertex;\n\t\tattribute vec3 normal;\n\t\tattribute vec2 uv;\n\n\t\tvarying highp vec2 v_uv;\n\t\tvarying highp vec3 v_normal;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tv_uv = uv;\n\t\t\tv_normal = normal;\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\tvarying highp vec3 v_normal;\n\t\t\n\t\tuniform highp float lightSteps;\n\t\tuniform sampler2D mainTex;\n\t\tuniform highp vec3 lightDir;\n\t\tuniform highp vec3 lightAmbient;\n\n\t\tvoid main() {\n\t\t\thighp vec4 col = texture2D(mainTex, v_uv);\n\t\t\tif (col.a != 1.0) discard;\n\t\t\thighp float pixel = mod(gl_FragCoord.x + gl_FragCoord.y, 2.0);\n\t\t\thighp float intensity = abs(dot(v_normal, lightDir)) * 2.2 - 0.2;\n\t\t\tintensity = floor(intensity * (lightSteps + 0.5) + pixel/2.0) / lightSteps;\n\t\t\tintensity = clamp(intensity, 0.0, 1.0);\n\t\t\tgl_FragColor = vec4(mix(col.rgb * lightAmbient, col.rgb, intensity), 1.0);\n\t\t}\n\t");return{program:e,locations:{uv:e.getAttribLocation("uv"),normal:e.getAttribLocation("normal"),mvp:e.getUniformLocation("mvp"),lightSteps:e.getUniformLocation("lightSteps"),lightAmbient:e.getUniformLocation("lightAmbient"),mainTex:e.getUniformLocation("mainTex"),lightDir:e.getUniformLocation("lightDir")}}}(e),this._wireframe=null,this._programWireframe=function(t){const e=new m(t,"\n\t\tattribute vec4 vertex;\n\n\t\tuniform mat4 mvp;\n\n\t\tvoid main() {\n\t\t\tgl_Position = mvp * vertex;\n\t\t}\n\t","\n\t\tuniform lowp vec4 color;\n\n\t\tvoid main() {\n\t\t\tgl_FragColor = color;\n\t\t}\n\t");return{program:e,locations:{mvp:e.getUniformLocation("mvp"),color:e.getUniformLocation("color")}}}(e),this._programText=function(t){const e=new m(t,"\n\t\tattribute vec2 vertex;\n\t\tattribute vec2 uv;\n\n\t\tvarying highp vec2 v_uv;\n\n\t\tuniform highp vec4 data;\n\n\t\tvoid main() {\n\t\t\tv_uv = uv;\n\t\t\tgl_Position = vec4((data.xy + vertex) * data.zw, 0.0, 1.0);\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\t\n\t\tuniform sampler2D mainTex;\n\t\tuniform lowp vec4 color;\n\n\t\tvoid main() {\n\t\t\tgl_FragColor = texture2D(mainTex, v_uv) * color;\n\t\t}\n\t");return{program:e,locations:{uv:e.getAttribLocation("uv"),data:e.getUniformLocation("data"),mainTex:e.getUniformLocation("mainTex"),color:e.getUniformLocation("color")}}}(e),this._programFramebuffer=function(t){const e=new m(t,"\n\t\tattribute vec4 vertex;\n\n\t\tvarying highp vec2 v_uv;\n\n\t\tvoid main() {\n\t\t\tv_uv = 0.5 + vertex.xy * 0.5;\n\t\t\tgl_Position = vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\t\n\t\tuniform sampler2D mainTex;\n\n\t\tvoid main() {\n\t\t\tgl_FragColor = texture2D(mainTex, v_uv);\n\t\t}\n\t");return{program:e,locations:{mainTex:e.getUniformLocation("mainTex")}}}(e),this._programOutline=function(t){const e=new m(t,"\n\t\tattribute vec4 vertex;\n\n\t\tvarying highp vec2 v_uv;\n\n\t\tvoid main() {\n\t\t\tv_uv = 0.5 + vertex.xy * 0.5;\n\t\t\tgl_Position = vertex;\n\t\t}\n\t","\n\t\tvarying highp vec2 v_uv;\n\t\t\n\t\tuniform sampler2D mainTex;\n\t\tuniform highp vec2 pixel;\n\t\tuniform lowp vec4 outlineColor;\n\n\t\tvoid main() {\n\t\t\tlowp float a = 1.0 - texture2D(mainTex, v_uv).a;\n\t\t\tlowp float b = texture2D(mainTex, v_uv + vec2(pixel.x, 0.0)).a + texture2D(mainTex, v_uv - vec2(pixel.x, 0.0)).a + texture2D(mainTex, v_uv + vec2(0.0, pixel.y)).a + texture2D(mainTex, v_uv - vec2(0.0, pixel.y)).a;\n\t\t\tgl_FragColor = mix(\n\t\t\t\tmix(\n\t\t\t\t\ttexture2D(mainTex, v_uv),\n\t\t\t\t\tvec4(0.0, 0.0, 0.0, 0.0),\n\t\t\t\t\ta\n\t\t\t\t),\n\t\t\t\toutlineColor,\n\t\t\t\tmin(1.0, a * b)\n\t\t\t);\n\t\t}\n\t");return{program:e,locations:{mainTex:e.getUniformLocation("mainTex"),pixel:e.getUniformLocation("pixel"),outlineColor:e.getUniformLocation("outlineColor")}}}(e),this._depthBuffer=e.createRenderbuffer(),this._frameBuffer=e.createFramebuffer(),this._frameBuffer2=e.createFramebuffer(),this._framebufferCurrent=null,this._screenQuads=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._screenQuads),e.bufferData(e.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),e.STATIC_DRAW);const r=t.resolution;null==r?this.setResolution(128,128,1):this.setResolution(r.width,r.height,r.scale??1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.pixelStorei(e.UNPACK_ALIGNMENT,1)}setResolution(t,e,r=1){if(null!=this._resolution&&this._resolution[0]===t&&this._resolution[1]===e&&this._resolution[2]===r)return;this._resolution=[t,e,r,0,0];const i=t*r,n=e*r,o=this.gl,a=this.canvas;a.width=i,a.height=n,this._frameBufferTex=this._createTexture(this._frameBufferTex,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,null,t,e),this._frameBufferTex2=this._createTexture(this._frameBufferTex2,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,null,t,e),o.bindRenderbuffer(o.RENDERBUFFER,this._depthBuffer),o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH_COMPONENT16,t,e),o.bindFramebuffer(o.FRAMEBUFFER,this._frameBuffer),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,this._frameBufferTex,0),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_ATTACHMENT,o.RENDERBUFFER,this._depthBuffer),o.bindFramebuffer(o.FRAMEBUFFER,this._frameBuffer2),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,this._frameBufferTex2,0),a.style.width=`${i}px`,a.style.height=`${n}px`}getResolution(){return{width:this._resolution[0],height:this._resolution[1],scale:this._resolution[2]}}get modelTexture(){return this.getModelTexture()}getModelTexture(){return this.model.textureAsImage(this._lightMapColors)}resetLightMap(){null!=this._lightMapTex&&this.gl.deleteTexture(this._lightMapTex),this._lightMapTex=this._createTexture(null,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,g()),this._lightMapColors=i.slice()}getPalette(){let t=this._lightMapColors.map((t=>[t[0],t[1],t[2],255]));if(this.drawWireframe){const e=T(this.wireframeColor);4!=e.length&&e.push(255),t.push(e)}if(this.outlineSize>=1){const e=T(this.outlineColor);4!=e.length&&e.push(255),t.push(e)}if(null!=this.backgroundColor){const e=T(this.backgroundColor);4!=e.length&&e.push(255),t.push(e)}return t}getRenderedBackgroundColor(){if(null==this.backgroundColor){const t=this._lightMapColors[this.model.backgroundIndex];return[t[0],t[1],t[2],255]}return[Math.floor(255.999*this.backgroundColor[0]),Math.floor(255.999*this.backgroundColor[1]),Math.floor(255.999*this.backgroundColor[2]),this.backgroundColor.length<=3?255:Math.floor(255.999*this.backgroundColor[3])]}_getLightMapColors(t){const e=t.data,r=Array(16),i=new Set;for(let t=0;t<16;t++){let n=8*t,o=e[n],a=e[n+1],s=e[n+2],l=[o,a,s];r[t]=l,i.add(o+256*a+65536*s)}for(let t=0;t<e.length;t+=4){let n=e[t],o=e[t+1],a=e[t+2],s=n+256*o+65536*a;i.has(s)||(i.add(s),r.push([n,o,a]))}return r}setLightMap(t){null!=this._lightMapTex&&this.gl.deleteTexture(this._lightMapTex),this._lightMapColors=this._getLightMapColors(t),this._lightMapTex=this._createTexture(null,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,t)}_freeMainTexture(){null!=this._indexTex&&(this.gl.deleteTexture(this._indexTex),this._indexTex=null)}setIndexTexture(t,e,r){let n,o;if(t instanceof ImageData){n=t;const e=n.width*n.height;o=new Uint8Array(e);const r=new Map(i.map((([t,e,r],i)=>[4278190080|r<<16|e<<8|t,this.model.alphaIndex===i?255:i]))),a=new Int32Array(t.data.buffer);for(let t=0;t<e;t++){const e=a[t];o[t]=r.get(e)??0}}else{o=t instanceof Uint8Array?t:new Uint8Array(t),n=new ImageData(e,r);const a=n.data;let s=0;for(let t=0;t<r;t++)for(let t=0;t<e;t++){const[t,e,r]=i[s]??i[0];a[s++]=t,a[s++]=e,a[s++]=r,a[s++]=255}}this._freeMainTexture(),this._indexTex=this._createTexture(this._indexTex,this.gl.LUMINANCE,this.gl.LUMINANCE,this.gl.UNSIGNED_BYTE,o,n.width,n.height)}setHDTexture(t){null!=t?this._hdTex=this._createTexture(this._hdTex,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t):this.removeHDTexture()}hasHDTexture(){return null!=this._hdTex}removeHDTexture(){null!=this._hdTex&&(this.gl.deleteTexture(this._hdTex),this._hdTex=null)}getWatermark(){return this._watermarkText}setWatermark(t){if(null!=t&&0!==t.trim().length||(t=null),t!==this._watermarkText&&(this._watermarkText=t,t)){let e=[],r={"â–®":16,"â– ":17,"â–¡":18,"â™":19,"â˜":20,"â€–":21,"â—€":22,"â–¶":23,"ã€Œ":24,"ã€":25,"Â¥":26,"â€¢":27,"ã€":28,"ã€‚":29,"ã‚›":30,"ã‚œ":31,"â—‹":127,"â–ˆ":128,"â–’":129,"ðŸ±":130,"â¬‡ï¸":131,"â–‘":132,"âœ½":133,"â—":134,"â™¥":135,"â¤":135,"â˜‰":136,"ì›ƒ":137,"ðŸ§â€â™€ï¸":137,"ðŸ§â€â™‚ï¸":137,"âŒ‚":138,"ðŸ ":138,"â¬…ï¸":139,"ðŸ™‚":140,"ðŸ˜":140,"â™ª":141,"ðŸŽµ":141,"ðŸ…¾ï¸":142,"â—†":143,"â€¦":144,"âž¡ï¸":145,"â˜…":146,"â§—":147,"â³":147,"â¬†ï¸":148,"Ë‡":149,"âˆ§":150,"âŽ":151,"â–¤":152,"â–¥":153,"ãƒ¼":254};for(let i of t){let t=32;if(r.hasOwnProperty(i))t=r[i];else if(1===i.length){let r=i.charCodeAt(0);r>=65&&r<=90?t=r-65+97:r>=97&&r<=122?t=r-97+65:r<128?t=r:r>=65280&&r<=65374?t=r-65280+32:r>=12352&&r<=12543&&(t=154,r>=12448&&(r-=96,t=204),r<=12362?t+=Math.floor((r-12353)/2):12387===r?t+=46:r<=12393?(r>12387&&r--,r-=12363,t+=5+Math.floor(r/2),r%2==1&&(e.push(t),t=30)):r<=12398?t+=r-12394+20:r<=12413?(r-=12399,t+=25+Math.floor(r/3),r%3==1&&(e.push(t),t=30),r%3==2&&(e.push(t),t=31)):r<=12418?t+=r-12414+30:r<=12424?(r-=12419,t+=35+Math.floor(r/2),r%2==0&&(t+=12)):r<=12429?t+=r-12425+38:r<=12431?t+=43:12434===r?t+=44:12435===r&&(t+=45))}e.push(t)}let i=new Float32Array(24*e.length),n=0,o=0,a=0,s=0,l=(t,e,r,o)=>{i[n++]=t,i[n++]=e,i[n++]=r,i[n++]=o};for(let t=0;t<e.length;t++){let r=e[t],i=35==r?6:r<128?4:8,n=5,h=o+i,u=a+n,f=r%16/16,c=Math.floor(r/16)/16,m=f+i/128,g=c+n/128;l(o,a,f,c),l(o,u,f,g),l(h,u,m,g),l(o,a,f,c),l(h,u,m,g),l(h,a,m,c),o+=i,s+=i,0==t&&s--}const h=this.gl;null==this._watermarkBuffer&&(this._watermarkBuffer=h.createBuffer()),h.bindBuffer(h.ARRAY_BUFFER,this._watermarkBuffer),h.bufferData(h.ARRAY_BUFFER,i,h.STATIC_DRAW),this._watermarkSize=[s,5],this._watermarkTriangleCount=6*e.length}}_createTexture(t,e,r,i,n,o,a){const s=this.gl;return null==t&&(t=s.createTexture()),s.bindTexture(s.TEXTURE_2D,t),null==o?s.texImage2D(s.TEXTURE_2D,0,e,r,i,n):s.texImage2D(s.TEXTURE_2D,0,e,o,a,0,r,i,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),t}async load(t){if("string"==typeof t)t.startsWith("picocad;")?this._loadString(t):await this._loadUrl(t);else if(t instanceof URL)await this._loadUrl(t);else if(t instanceof Blob)await this._loadBlob(t);else{if(!(t instanceof n))throw TypeError();this._loadModel(t)}return this.model}async _loadUrl(t){const e=await fetch(String(t));if(!e.ok)throw Error(`${e.status}: ${e.statusText}`);this._loadString(await e.text())}_loadBlob(t){return new Promise(((e,r)=>{if(!t.type.startsWith("text"))throw Error("picoCAD file must be a text file");const i=new FileReader;i.onload=()=>{e(this._loadString(i.result))},i.onerror=()=>{r(i.error)},i.readAsText(t)}))}_loadString(t){this._loadModel(_(t))}_loadModel(t){const e=this.gl;if(this.loaded=!1,this.model=null,this.loaded){for(const t of this._passes)t.free();this._passes=[],this._wireframe.free(),e.deleteTexture(this._indexTex),this._indexTex=null}const r=h(e,t,this.tesselationCount);this._passes=r.passes,this._wireframe=r.wireframe,this._indexTex=this._createTexture(this._indexTex,e.LUMINANCE,e.LUMINANCE,e.UNSIGNED_BYTE,new Uint8Array(r.textureIndices),128,128),this.loaded=!0,this.model=t}draw(){const r="none"!==this.renderMode,i="color"===this.renderMode;if(!this.loaded||!r&&!this.drawWireframe)return;const n=this.gl,o=this.canvas;n.bindFramebuffer(n.FRAMEBUFFER,this._frameBuffer),n.viewport(0,0,this._resolution[0],this._resolution[1]),n.clearColor(0,0,0,0),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT);const a=(s=new t(16),t!=Float32Array&&(s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=0,s[12]=0,s[13]=0,s[14]=0),s[0]=1,s[5]=1,s[10]=1,s[15]=1,s);var s;e(a,this.cameraFOV*Math.PI/180,this._resolution[0]/this._resolution[1],.1,400),function(t,e,r){var i=Math.sin(r),n=Math.cos(r),o=e[4],a=e[5],s=e[6],l=e[7],h=e[8],u=e[9],f=e[10],c=e[11];e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*n+h*i,t[5]=a*n+u*i,t[6]=s*n+f*i,t[7]=l*n+c*i,t[8]=h*n-o*i,t[9]=u*n-a*i,t[10]=f*n-s*i,t[11]=c*n-l*i}(a,a,this.cameraRotation.x),function(t,e,r){var i=Math.sin(r),n=Math.cos(r),o=e[0],a=e[1],s=e[2],l=e[3],h=e[8],u=e[9],f=e[10],c=e[11];e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*n-h*i,t[1]=a*n-u*i,t[2]=s*n-f*i,t[3]=l*n-c*i,t[8]=o*i+h*n,t[9]=a*i+u*n,t[10]=s*i+f*n,t[11]=l*i+c*n}(a,a,this.cameraRotation.y),function(t,e,r){var i=Math.sin(r),n=Math.cos(r),o=e[0],a=e[1],s=e[2],l=e[3],h=e[4],u=e[5],f=e[6],c=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*n+h*i,t[1]=a*n+u*i,t[2]=s*n+f*i,t[3]=l*n+c*i,t[4]=h*n-o*i,t[5]=u*n-a*i,t[6]=f*n-s*i,t[7]=c*n-l*i}(a,a,this.cameraRotation.z),function(t,e,r){var i,n,o,a,s,l,h,u,f,c,m,g,d=r[0],x=r[1],_=r[2];e===t?(t[12]=e[0]*d+e[4]*x+e[8]*_+e[12],t[13]=e[1]*d+e[5]*x+e[9]*_+e[13],t[14]=e[2]*d+e[6]*x+e[10]*_+e[14],t[15]=e[3]*d+e[7]*x+e[11]*_+e[15]):(i=e[0],n=e[1],o=e[2],a=e[3],s=e[4],l=e[5],h=e[6],u=e[7],f=e[8],c=e[9],m=e[10],g=e[11],t[0]=i,t[1]=n,t[2]=o,t[3]=a,t[4]=s,t[5]=l,t[6]=h,t[7]=u,t[8]=f,t[9]=c,t[10]=m,t[11]=g,t[12]=i*d+s*x+f*_+e[12],t[13]=n*d+l*x+c*_+e[13],t[14]=o*d+h*x+m*_+e[14],t[15]=a*d+u*x+g*_+e[15])}(a,a,[this.cameraPosition.x,this.cameraPosition.y,this.cameraPosition.z]);const l=function(t){let e=Math.hypot(t.x,t.y,t.z);0===e&&(e=1);return{x:t.x/e,y:t.y/e,z:t.z/e}}(this.lightDirection);if(r)for(const t of this._passes){if(t.clearDepth&&n.clear(n.DEPTH_BUFFER_BIT),t.isEmpty())continue;const e=i||!t.texture,r=null==this._hdTex||e?this.shading&&t.shading?this._programTexture:this._programUnlitTexture:this._programHDTexture;r.program.use(),n.uniformMatrix4fv(r.locations.mvp,!1,a),n.bindBuffer(n.ARRAY_BUFFER,t.vertexBuffer),n.vertexAttribPointer(r.program.vertexLocation,3,n.FLOAT,!1,0,0),n.enableVertexAttribArray(r.program.vertexLocation),n.bindBuffer(n.ARRAY_BUFFER,e?t.colorUVBuffer:t.uvBuffer),n.vertexAttribPointer(r.locations.uv,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(r.locations.uv),r===this._programUnlitTexture?(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,e?this._colorIndexTex:this._indexTex),n.uniform1i(r.locations.indexTex,0),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,this._lightMapTex),n.uniform1i(r.locations.lightMap,1)):r===this._programTexture?(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,e?this._colorIndexTex:this._indexTex),n.uniform1i(r.locations.indexTex,0),n.activeTexture(n.TEXTURE1),n.bindTexture(n.TEXTURE_2D,this._lightMapTex),n.uniform1i(r.locations.lightMap,1),n.uniform1f(r.locations.lightMapOffset,-.3571428571428572),n.uniform1f(r.locations.lightMapGradient,2.857142857142857),n.uniform3f(r.locations.lightDir,l.x,l.y,l.z),n.bindBuffer(n.ARRAY_BUFFER,t.normalBuffer),n.vertexAttribPointer(r.locations.normal,3,n.FLOAT,!1,0,0),n.enableVertexAttribArray(r.locations.normal)):r===this._programHDTexture&&(n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._hdTex),n.uniform1i(r.locations.mainTex,0),n.uniform3f(r.locations.lightDir,l.x,l.y,l.z),n.uniform1f(r.locations.lightSteps,this.hdOptions.shadingSteps),n.uniform3f(r.locations.lightAmbient,this.hdOptions.shadingColor[0],this.hdOptions.shadingColor[1],this.hdOptions.shadingColor[2]),n.bindBuffer(n.ARRAY_BUFFER,t.normalBuffer),n.vertexAttribPointer(r.locations.normal,3,n.FLOAT,!1,0,0),n.enableVertexAttribArray(r.locations.normal)),t.cull?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.triangleBuffer),n.drawElements(n.TRIANGLES,t.vertexCount,n.UNSIGNED_SHORT,0),n.disableVertexAttribArray(r.program.vertexLocation),n.disableVertexAttribArray(r.locations.uv),r===this._programTexture&&n.disableVertexAttribArray(r.locations.normal)}this.drawWireframe&&(r&&this.wireframeXray&&n.clear(n.DEPTH_BUFFER_BIT),this._programWireframe.program.use(),n.uniformMatrix4fv(this._programWireframe.locations.mvp,!1,a),n.uniform4fv(this._programWireframe.locations.color,[this.wireframeColor[0],this.wireframeColor[1],this.wireframeColor[2],1]),n.bindBuffer(n.ARRAY_BUFFER,this._wireframe.vertexBuffer),n.vertexAttribPointer(this._programWireframe.program.vertexLocation,3,n.FLOAT,!1,0,0),n.enableVertexAttribArray(this._programWireframe.program.vertexLocation),n.drawArrays(n.LINES,0,this._wireframe.vertexCount));let h=this._frameBufferTex,u=this.outlineSize;if(u>0&&(n.bindFramebuffer(n.FRAMEBUFFER,this._frameBuffer2),n.clear(n.COLOR_BUFFER_BIT)),u>0){let t=this._programOutline;t.program.use(),n.uniform2f(t.locations.pixel,1/this._resolution[0],1/this._resolution[1]),n.uniform4f(t.locations.outlineColor,this.outlineColor[0],this.outlineColor[1],this.outlineColor[2],this.outlineColor[3]??1),n.bindBuffer(n.ARRAY_BUFFER,this._screenQuads),n.vertexAttribPointer(t.program.vertexLocation,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(t.program.vertexLocation);for(let e=0;e<u;e++){let e;h===this._frameBufferTex?(n.bindFramebuffer(n.FRAMEBUFFER,this._frameBuffer2),e=this._frameBufferTex2):(n.bindFramebuffer(n.FRAMEBUFFER,this._frameBuffer),e=this._frameBufferTex),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,h),n.uniform1i(t.locations.mainTex,0),n.drawArrays(n.TRIANGLES,0,6),h=e}}if(this._framebufferCurrent=h===this._frameBufferTex?this._frameBuffer:this._frameBuffer2,this._watermarkText){if(!this._fontTex){let t=R();t&&(this._fontTex=this._createTexture(this._fontTex,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t))}if(this._fontTex){let t=this._programText;t.program.use(),n.bindBuffer(n.ARRAY_BUFFER,this._watermarkBuffer),n.vertexAttribPointer(t.program.vertexLocation,2,n.FLOAT,!1,16,0),n.enableVertexAttribArray(t.program.vertexLocation),n.vertexAttribPointer(t.locations.uv,2,n.FLOAT,!1,16,8),n.enableVertexAttribArray(t.locations.uv);let e,r=2;n.uniform4f(t.locations.data,this._resolution[0]/2-this._watermarkSize[0]-r,this._resolution[1]/2-this._watermarkSize[1]-r,2/this._resolution[0],-2/this._resolution[1]);let i=this.backgroundColor;if(i){let t=v(i[0],i[1],i[2])>.5,r=null;for(let i of this._lightMapColors){let n=v(i[0]/255,i[1]/255,i[2]/255);t&&(n=1-n),(!e||n>r)&&(e=i,r=n)}}else e=this._lightMapColors[(this.model.backgroundIndex+8)%16];n.uniform4f(t.locations.color,e[0]/255,e[1]/255,e[2]/255,1),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,this._fontTex),n.uniform1i(t.locations.mainTex,0),n.drawArrays(n.TRIANGLES,0,this._watermarkTriangleCount)}}if(n.bindFramebuffer(n.FRAMEBUFFER,null),n.viewport(0,0,o.width,o.height),null==this.backgroundColor){const t=this._lightMapColors[this.model.backgroundIndex];n.clearColor(t[0]/255,t[1]/255,t[2]/255,1)}else n.clearColor(this.backgroundColor[0],this.backgroundColor[1],this.backgroundColor[2],this.backgroundColor[3]??1);n.clear(n.COLOR_BUFFER_BIT);let f=this._programFramebuffer;f.program.use(),n.activeTexture(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,h),n.uniform1i(f.locations.mainTex,0),n.bindBuffer(n.ARRAY_BUFFER,this._screenQuads),n.vertexAttribPointer(f.program.vertexLocation,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(f.program.vertexLocation),n.drawArrays(n.TRIANGLES,0,6)}startDrawLoop(t,e){let r=performance.now(),i=r;const n=()=>{if(null!=t){const e=performance.now();t((e-r)/1e3),r=e}if(this.draw(),null!=e){const t=performance.now();e((t-i)/1e3),i=t}this._rafID=requestAnimationFrame(n)};this._rafID=requestAnimationFrame(n)}stopDrawLoop(){null!=this._rafID&&cancelAnimationFrame(this._rafID)}getCameraRight(){return this._transformDirection(1,0,0)}getCameraUp(){return this._transformDirection(0,-1,0)}getCameraForward(){return this._transformDirection(0,0,-1)}setLightDirectionFromCamera(){const t=this.getCameraUp(),e=this.getCameraForward();this.lightDirection={x:e.x-.4*t.x,y:e.y-.4*t.y,z:e.z-.4*t.z}}getTextureColorCount(t=!1){const e=Array(16).fill(!1);let r=0;for(const t of this.model.texture)e[t]||(e[t]=!0,r++);return r}getTriangleCount(){let t=0;for(const e of this._passes)t+=Math.floor(e.vertexCount/3);return t}getDrawCallCount(){let t=1;for(const e of this._passes)e.isEmpty()||t++;return this.drawWireframe&&t++,t+=this.outlineSize,t}_transformDirection(t,e,i){const n=r();!function(t,e,r,i){t[0]=e,t[1]=r,t[2]=i}(n,t,e,i);const o=((a=r())[0]=0,a[1]=0,a[2]=0,a);var a;return function(t,e,r,i){var n=[],o=[];n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],o[0]=n[0],o[1]=n[1]*Math.cos(i)-n[2]*Math.sin(i),o[2]=n[1]*Math.sin(i)+n[2]*Math.cos(i),t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2]}(n,n,o,Math.PI+this.cameraRotation.x),function(t,e,r,i){var n=[],o=[];n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],o[0]=n[2]*Math.sin(i)+n[0]*Math.cos(i),o[1]=n[1],o[2]=n[2]*Math.cos(i)-n[0]*Math.sin(i),t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2]}(n,n,o,this.cameraRotation.y),function(t,e,r,i){var n=[],o=[];n[0]=e[0]-r[0],n[1]=e[1]-r[1],n[2]=e[2]-r[2],o[0]=n[0]*Math.cos(i)-n[1]*Math.sin(i),o[1]=n[0]*Math.sin(i)+n[1]*Math.cos(i),o[2]=n[2],t[0]=o[0]+r[0],t[1]=o[1]+r[1],t[2]=o[2]+r[2]}(n,n,o,Math.PI+this.cameraRotation.z),{x:n[0],y:n[1],z:n[2]}}setTurntableCamera(t,e,r,i={x:0,y:1.5,z:0}){const n=Math.PI-e;r=-r,this.cameraPosition={x:t*Math.cos(r)*Math.sin(n)-i.x,y:t*Math.sin(r)-i.y,z:t*Math.cos(r)*Math.cos(n)-i.z},this.cameraRotation={y:e,x:-r,z:0}}getPixels(){const t=this.gl,[e,r]=this._resolution,i=new Uint8Array(4*(e*r));return t.bindFramebuffer(t.FRAMEBUFFER,this._framebufferCurrent),t.readPixels(0,0,e,r,t.RGBA,t.UNSIGNED_BYTE,i),t.bindFramebuffer(t.FRAMEBUFFER,null),i}getPixelIndices(t=1){const e=this.gl,[r,i]=this._resolution,n=r*i,o=r*t,a=o*t,s=t*t;t=Math.max(1,Math.floor(t));const l=new Uint8Array(4*n);e.bindFramebuffer(e.FRAMEBUFFER,this._framebufferCurrent),e.readPixels(0,0,r,i,e.RGBA,e.UNSIGNED_BYTE,l),e.bindFramebuffer(e.FRAMEBUFFER,null);const h=this.getPalette(),u=new Map(h.map(((t,e)=>[p(t),e])));u.set(0,this.backgroundColor?h.length-1:this.model.backgroundIndex);const f=new Uint32Array(l.buffer),c=new Uint8Array(n*s);let m=n-r,g=0;for(let e=0;e<i;e++){let e=m,i=g;for(let n=0;n<r;n++){const r=f[e],n=u.get(r)??0;if(1===t)c[i]=n;else{let e=i;for(let r=0;r<t;r++){for(let r=0;r<t;r++)c[e+r]=n;e+=o}}i+=t,e++}m-=r,g+=a}return c}free(){const t=this.gl;this.stopDrawLoop();for(const t of this._passes)t.free();this._passes=[],t.deleteTexture(this._lightMapTex),t.deleteTexture(this._indexTex),this._lightMapTex=null,this._indexTex=null,this._programTexture.program.free(),this._programWireframe.program.free(),this._programTexture=null,this._programWireframe=null,t.deleteFramebuffer(this._frameBuffer),t.deleteFramebuffer(this._frameBuffer2),t.deleteTexture(this._frameBufferTex),t.deleteTexture(this._frameBufferTex2),t.deleteBuffer(this._screenQuads),t.deleteRenderbuffer(this._depthBuffer),this._programFramebuffer.program.free(),this._frameBuffer=null,this._frameBuffer2=null,this._framebufferCurrent=null,this._frameBufferTex=null,this._frameBufferTex2=null,this._screenQuads=null,this._depthBuffer=null,this._programFramebuffer=null,this._programText.program.free(),this._watermarkBuffer&&(t.deleteBuffer(this._watermarkBuffer),this._watermarkBuffer=null),this._fontTex&&(t.deleteTexture(this._fontTex),this._fontTex=null)}}}();
